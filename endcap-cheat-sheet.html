<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suncare Endcap — Visual Layout Guide</title>
  <style>
    @page {
      size: landscape;
      margin: 0.35in 0.4in;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #F8F6F1;
      --header-bg: #1A1E2E;
      --gold: #C5993E;
      --gold-light: #E8D5A8;
      --text: #2C3040;
      --text-dim: #6B7085;
      --card-bg: #FFFFFF;
      --upc-bg: #1A1E2E;
      --upc-text: #F0EDE6;
      --shelf-edge: #C5993E;
      --new-badge: #2E7D32;
      --srp-badge: #7B1FA2;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-serif: Georgia, "Times New Roman", serif;
      --font-mono: "Courier New", Courier, monospace;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      padding: 0;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.2rem;
      color: var(--text-dim);
      font-style: italic;
    }

    .page {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg);
      page-break-after: always;
      break-after: page;
    }

    .page:last-child {
      page-break-after: auto;
      break-after: auto;
    }

    .page-header {
      background: var(--header-bg);
      color: #fff;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--gold);
    }

    .page-header-left h1 {
      font-family: var(--font-serif);
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      margin-bottom: 2px;
    }

    .page-header-left h1 .gold { color: var(--gold); }

    .page-header-left .subtitle {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.6);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .page-header-right {
      text-align: right;
    }

    .page-header-right .fixture-label {
      font-family: var(--font-serif);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }

    .page-header-right .meta {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.55);
      margin-top: 2px;
    }

    .shelves-wrapper {
      padding: 10px 16px 6px;
    }

    .shelf {
      margin-bottom: 6px;
    }

    .shelf:last-child {
      margin-bottom: 0;
    }

    .shelf-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 2px 0;
      border-bottom: 1px solid var(--gold-light);
      margin-bottom: 3px;
    }

    .shelf-label span:first-child {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text);
    }

    .shelf-count {
      font-size: 0.6rem;
      color: var(--text-dim);
      font-weight: 400;
    }

    .shelf-row {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 4px;
      flex-wrap: nowrap;
      padding-bottom: 2px;
      min-height: 30px;
    }

    .shelf-edge {
      height: 3px;
      background: linear-gradient(90deg, var(--shelf-edge), var(--gold-light), var(--shelf-edge));
      border-radius: 0 0 2px 2px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }

    .product {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 0 0 auto;
      width: calc(var(--width-in, 2.5) * var(--facings, 1) * var(--inch-scale, 10px));
    }

    .product-images {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: calc(var(--height-in, 6) * var(--inch-scale, 10px));
      width: 100%;
      background: var(--card-bg);
      border-radius: 3px 3px 0 0;
      padding: 1px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .product-images img {
      flex: 1 1 0;
      min-width: 0;
      height: 100%;
      object-fit: contain;
      object-position: bottom center;
      display: block;
    }

    .product-upc {
      width: 100%;
      background: var(--upc-bg);
      color: var(--upc-text);
      font-family: var(--font-mono);
      font-weight: 700;
      text-align: center;
      padding: 1px 1px;
      border-radius: 0 0 3px 3px;
      line-height: 1.15;
      letter-spacing: -0.02em;
      white-space: nowrap;
      overflow: hidden;
    }

    .badge-new {
      position: absolute;
      top: 1px;
      left: 1px;
      background: var(--new-badge);
      color: #fff;
      font-size: 5px;
      font-weight: 800;
      padding: 1px 2px;
      border-radius: 2px;
      letter-spacing: 0.04em;
      z-index: 10;
      line-height: 1.3;
    }

    .badge-srp {
      position: absolute;
      top: 1px;
      right: 1px;
      background: var(--srp-badge);
      color: #fff;
      font-size: 5px;
      font-weight: 800;
      padding: 1px 2px;
      border-radius: 2px;
      letter-spacing: 0.04em;
      z-index: 10;
      line-height: 1.3;
    }

    .page-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 16px;
      font-size: 0.6rem;
      color: var(--text-dim);
      border-top: 1px solid var(--gold-light);
    }

    .page-footer .brand {
      font-weight: 600;
      color: var(--gold);
    }

    @media print {
      body {
        background: #fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 0;
      }

      .page {
        max-width: none;
        margin: 0;
        box-shadow: none;
      }

      .page-header {
        padding: 8px 14px;
      }

      .page-header-left h1 { font-size: 1.1rem; }
      .page-header-right .fixture-label { font-size: 1.2rem; }

      .shelves-wrapper { padding: 6px 8px 2px; }
      .shelf { margin-bottom: 4px; }
      .shelf-row { gap: 2px; }

      .product-images {
        box-shadow: none;
        border: 1px solid #e0e0e0;
      }
    }

    @media screen {
      .page {
        box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        border-radius: 4px;
        overflow: hidden;
      }

      body { padding: 24px 16px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">Loading planogram data...</div>
  </div>

  <script>
    const FALLBACK_SVG = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 140'><rect width='100' height='140' fill='%23F0EDE6' rx='4'/><text y='50%25' x='50%25' dy='0.35em' text-anchor='middle' font-size='36'>☀️</text></svg>";

    function formatUpc(upc) {
      return String(upc).padStart(13, '0');
    }

    async function init() {
      try {
        const res = await fetch('data/endcap.json');
        const data = await res.json();
        renderCheatSheet(data);
      } catch (e) {
        document.getElementById('app').innerHTML =
          '<div class="loading">Failed to load data. Please ensure data/endcap.json exists.</div>';
      }
    }

    function renderCheatSheet(data) {
      const app = document.getElementById('app');
      app.innerHTML = '';

      const totalProducts = data.products.length;
      const newCount = data.products.filter(p => p.isNew).length;

      const shelvesPerPage = 3;
      const totalPages = Math.ceil(data.shelves / shelvesPerPage);

      for (let pageIdx = 0; pageIdx < totalPages; pageIdx++) {
        const startShelf = data.shelves - (pageIdx * shelvesPerPage);
        const endShelf = Math.max(1, startShelf - shelvesPerPage + 1);

        const page = document.createElement('div');
        page.className = 'page';

        const rangeLabel = startShelf === endShelf
          ? `Shelf ${startShelf}`
          : `Shelves ${startShelf}–${endShelf}`;

        page.innerHTML = `
          <div class="page-header">
            <div class="page-header-left">
              <h1><span class="gold">☀</span> Suncare Endcap — Visual Layout Guide</h1>
              <div class="subtitle">${data.subtitle}</div>
            </div>
            <div class="page-header-right">
              <div class="fixture-label">${rangeLabel}</div>
              <div class="meta">POG ${data.pogNumber} · Live ${data.liveDate} · ${totalProducts} SKUs${newCount ? ' · ' + newCount + ' New' : ''}</div>
            </div>
          </div>
          <div class="shelves-wrapper" id="shelves-page-${pageIdx}"></div>
          <div class="page-footer">
            <span class="brand">THE DUMP BIN</span>
            <span>Page ${pageIdx + 1} of ${totalPages} · ${data.name}</span>
          </div>
        `;

        app.appendChild(page);
      }

      requestAnimationFrame(() => {
        for (let pageIdx = 0; pageIdx < totalPages; pageIdx++) {
          const container = document.getElementById(`shelves-page-${pageIdx}`);
          const startShelf = data.shelves - (pageIdx * shelvesPerPage);
          const endShelf = Math.max(1, startShelf - shelvesPerPage + 1);
          if (container) renderPageShelves(data, startShelf, endShelf, container);
        }
      });
    }

    function renderPageShelves(data, startShelf, endShelf, container) {
      const allProducts = data.products;
      const containerWidth = container.clientWidth;

      let maxShelfWidthIn = 0;
      let maxItemCount = 0;

      for (let s = endShelf; s <= startShelf; s++) {
        const shelfProds = allProducts.filter(p => p.shelf === s);
        const shelfWidthIn = shelfProds.reduce(
          (acc, p) => acc + (p.widthIn || 2.5) * (p.facings || 1), 0
        );
        if (shelfWidthIn > maxShelfWidthIn) {
          maxShelfWidthIn = shelfWidthIn;
          maxItemCount = shelfProds.length;
        }
      }

      const GAP_PX = 4;
      const totalGaps = Math.max(0, maxItemCount - 1) * GAP_PX;
      const inchScale = maxShelfWidthIn > 0
        ? (containerWidth - totalGaps) / maxShelfWidthIn
        : 10;

      container.innerHTML = '';

      for (let s = startShelf; s >= endShelf; s--) {
        const shelfProds = allProducts
          .filter(p => p.shelf === s)
          .sort((a, b) => a.position - b.position);

        const label = s === data.shelves ? 'TOP' : (s === 1 ? 'BOTTOM' : '');

        const shelfDiv = document.createElement('div');
        shelfDiv.className = 'shelf';

        const shelfRow = document.createElement('div');
        shelfRow.className = 'shelf-row';
        shelfRow.style.setProperty('--inch-scale', `${inchScale}px`);

        shelfProds.forEach(p => {
          shelfRow.appendChild(createProductCard(p, inchScale));
        });

        shelfDiv.innerHTML = `
          <div class="shelf-label">
            <span>Shelf ${s}${label ? ' · ' + label : ''}</span>
            <span class="shelf-count">${shelfProds.length} items</span>
          </div>
        `;

        shelfDiv.appendChild(shelfRow);

        const edge = document.createElement('div');
        edge.className = 'shelf-edge';
        shelfDiv.appendChild(edge);

        container.appendChild(shelfDiv);
      }
    }

    function createProductCard(p, inchScale) {
      const widthIn = p.widthIn || 2.5;
      const heightIn = p.heightIn || 6;
      const facings = p.facings || 1;
      const upc = formatUpc(p.upc);
      const cardWidth = widthIn * facings * inchScale;

      const card = document.createElement('div');
      card.className = 'product';
      card.style.setProperty('--width-in', widthIn);
      card.style.setProperty('--height-in', heightIn);
      card.style.setProperty('--facings', facings);

      const imgContainer = document.createElement('div');
      imgContainer.className = 'product-images';

      for (let i = 0; i < facings; i++) {
        const img = document.createElement('img');
        img.src = `images/${p.upc}.webp`;
        img.loading = 'lazy';
        img.alt = p.name;
        img.onerror = function () {
          this.onerror = null;
          this.src = FALLBACK_SVG;
        };
        imgContainer.appendChild(img);
      }

      const upcDiv = document.createElement('div');
      upcDiv.className = 'product-upc';
      upcDiv.textContent = upc;

      const upcFontSize = Math.max(5.5, Math.min(11, cardWidth * 0.085));
      upcDiv.style.fontSize = `${upcFontSize}px`;

      card.appendChild(imgContainer);
      card.appendChild(upcDiv);

      if (p.isNew) {
        const badge = document.createElement('span');
        badge.className = 'badge-new';
        badge.textContent = 'NEW';
        card.appendChild(badge);
      }

      if (p.srp) {
        const badge = document.createElement('span');
        badge.className = 'badge-srp';
        badge.textContent = 'SRP';
        card.appendChild(badge);
      }

      return card;
    }

    init();
  </script>
</body>
</html>
